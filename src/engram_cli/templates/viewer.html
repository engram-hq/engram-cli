<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Engram Viewer - Skills & Memories</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/3d-force-graph@1.73.3/dist/3d-force-graph.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #09090b;
  --bg-secondary: #111113;
  --bg-tertiary: #18181b;
  --bg-hover: #1f1f23;
  --bg-active: #27272a;
  --border: #27272a;
  --border-light: #3f3f46;
  --text-primary: #fafafa;
  --text-secondary: #a1a1aa;
  --text-muted: #71717a;
  --accent-blue: #3b82f6;
  --accent-purple: #8b5cf6;
  --accent-green: #22c55e;
  --accent-amber: #f59e0b;
  --accent-rose: #f43f5e;
  --accent-cyan: #06b6d4;
  --accent-indigo: #6366f1;
  --accent-teal: #14b8a6;
  --scrollbar-track: #18181b;
  --scrollbar-thumb: #3f3f46;
}

html, body {
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow: hidden;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--scrollbar-track); }
::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #52525b; }

/* Layout */
.app { display: flex; flex-direction: column; height: 100vh; }

/* Header */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  height: 52px;
  min-height: 52px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
}
.header-left { display: flex; align-items: center; gap: 12px; }
.logo {
  font-size: 18px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}
.logo-sub { font-size: 12px; color: var(--text-muted); font-weight: 400; }
.header-stats { display: flex; gap: 16px; }
.stat { font-size: 12px; color: var(--text-secondary); }
.stat strong { color: var(--text-primary); font-variant-numeric: tabular-nums; }

/* Tabs */
.tabs {
  display: flex;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
}
.tab {
  padding: 10px 18px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
  user-select: none;
}
.tab:hover { color: var(--text-secondary); }
.tab.active {
  color: var(--text-primary);
  border-bottom-color: var(--accent-blue);
}

/* Tab panels */
.tab-content { flex: 1; overflow: hidden; display: none; }
.tab-content.active { display: flex; }

/* Skills tab */
.skills-layout { display: flex; width: 100%; height: 100%; }
.sidebar {
  width: 280px;
  min-width: 280px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.sidebar-header {
  padding: 12px 14px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
}
.sidebar-tree { flex: 1; overflow-y: auto; padding: 6px 0; }

.tree-org {
  margin-bottom: 2px;
}
.tree-org-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 14px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  transition: background 0.1s;
}
.tree-org-header:hover { background: var(--bg-hover); }
.tree-org-header .chevron {
  font-size: 10px;
  color: var(--text-muted);
  transition: transform 0.15s;
  width: 12px;
  text-align: center;
}
.tree-org-header.collapsed .chevron { transform: rotate(-90deg); }
.tree-org-header .dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.tree-org-children { }
.tree-org-header.collapsed + .tree-org-children { display: none; }

.tree-repo-header {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 5px 14px 5px 34px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  transition: background 0.1s;
}
.tree-repo-header:hover { background: var(--bg-hover); }
.tree-repo-header .chevron {
  font-size: 9px;
  color: var(--text-muted);
  transition: transform 0.15s;
  width: 10px;
  text-align: center;
}
.tree-repo-header.collapsed .chevron { transform: rotate(-90deg); }
.tree-repo-children { }
.tree-repo-header.collapsed + .tree-repo-children { display: none; }

.tree-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 14px 4px 52px;
  cursor: pointer;
  font-size: 12px;
  color: var(--text-secondary);
  transition: all 0.1s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.tree-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.tree-item.active { background: var(--bg-active); color: var(--text-primary); }
.tree-item .icon { font-size: 11px; flex-shrink: 0; }
.tree-item .label { overflow: hidden; text-overflow: ellipsis; }

/* Content panel */
.content-panel {
  flex: 1;
  overflow-y: auto;
  padding: 32px 48px;
  background: var(--bg-primary);
}
.content-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-muted);
  gap: 12px;
}
.content-empty-icon { font-size: 48px; opacity: 0.3; }
.content-empty-text { font-size: 14px; }

/* Content breadcrumb */
.content-breadcrumb {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 16px;
}
.content-breadcrumb span { color: var(--text-secondary); }
.content-type-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-left: 8px;
}
.badge-skill { background: rgba(59,130,246,0.15); color: var(--accent-blue); }
.badge-memory { background: rgba(139,92,246,0.15); color: var(--accent-purple); }

/* Frontmatter display */
.frontmatter-table {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 24px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 8px;
}
.fm-item { font-size: 12px; }
.fm-key { color: var(--text-muted); font-weight: 500; }
.fm-val { color: var(--text-secondary); margin-left: 4px; }

/* Markdown content */
.md-content { line-height: 1.7; font-size: 14px; color: var(--text-secondary); }
.md-content h1 { font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 28px 0 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
.md-content h2 { font-size: 20px; font-weight: 600; color: var(--text-primary); margin: 24px 0 10px; }
.md-content h3 { font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 20px 0 8px; }
.md-content h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 16px 0 6px; }
.md-content p { margin: 10px 0; }
.md-content a { color: var(--accent-blue); text-decoration: none; }
.md-content a:hover { text-decoration: underline; }
.md-content code {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1px 5px;
  font-size: 13px;
  font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
  color: var(--accent-amber);
}
.md-content pre {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  overflow-x: auto;
  margin: 14px 0;
}
.md-content pre code {
  background: none;
  border: none;
  padding: 0;
  color: var(--text-secondary);
  font-size: 12.5px;
  line-height: 1.6;
}
.md-content ul, .md-content ol { margin: 10px 0; padding-left: 24px; }
.md-content li { margin: 4px 0; }
.md-content blockquote {
  border-left: 3px solid var(--accent-blue);
  padding: 8px 16px;
  margin: 12px 0;
  background: rgba(59,130,246,0.05);
  color: var(--text-secondary);
}
.md-content table { border-collapse: collapse; margin: 12px 0; width: 100%; }
.md-content th, .md-content td {
  border: 1px solid var(--border);
  padding: 8px 12px;
  font-size: 13px;
  text-align: left;
}
.md-content th { background: var(--bg-tertiary); font-weight: 600; color: var(--text-primary); }
.md-content hr { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
.md-content strong { color: var(--text-primary); }

/* Timeline tab - 3-panel layout */
.timeline-3panel {
  display: grid;
  grid-template-columns: 200px 1fr 320px;
  width: 100%;
  height: 100%;
  overflow: hidden;
}
.tl-left {
  background: rgba(255,255,255,0.02);
  border-right: 1px solid var(--border);
  padding: 16px;
  overflow-y: auto;
}
.tl-left h4 {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
}
.tl-org-item {
  padding: 6px 8px;
  font-size: 12px;
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 2px;
}
.tl-org-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.tl-org-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.tl-session-item {
  padding: 5px 8px 5px 26px;
  font-size: 11px;
  color: var(--text-muted);
  cursor: pointer;
  border-radius: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.tl-session-item:hover { background: var(--bg-hover); color: var(--text-primary); }
.tl-session-item.active { color: var(--accent-purple); background: rgba(139,92,246,0.1); }
.tl-graph {
  position: relative;
  overflow: hidden;
  background: #050508;
}
.tl-graph canvas { display: block; }
.tl-controls {
  position: absolute;
  top: 12px;
  right: 12px;
  display: flex;
  gap: 6px;
  z-index: 10;
}
.timeline-btn {
  padding: 5px 12px;
  background: rgba(17,17,19,0.85);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-secondary);
  font-size: 11px;
  cursor: pointer;
  backdrop-filter: blur(10px);
  transition: all 0.15s;
}
.timeline-btn:hover { color: var(--text-primary); border-color: var(--border-light); }
.timeline-btn.active { color: var(--accent-blue); border-color: var(--accent-blue); }
.tl-legend {
  position: absolute;
  bottom: 10px;
  left: 10px;
  font-size: 10px;
  color: var(--text-muted);
  background: rgba(9,9,11,0.85);
  padding: 6px 10px;
  border-radius: 6px;
  z-index: 10;
  pointer-events: none;
}
.tl-right {
  background: rgba(255,255,255,0.02);
  border-left: 1px solid var(--border);
  padding: 16px;
  overflow-y: auto;
}
.tl-right h3 { font-size: 14px; margin-bottom: 8px; }
.tl-metrics {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  margin-bottom: 12px;
}
.tl-metric-card {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 10px;
}
.tl-metric-card .label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.03em; }
.tl-metric-card .value { font-size: 14px; font-weight: 600; }
.tl-detail-content {
  font-size: 13px;
  line-height: 1.6;
  color: var(--text-secondary);
}
.tl-detail-content h1, .tl-detail-content h2 { font-size: 15px; color: var(--text-primary); margin: 12px 0 4px; }
.tl-detail-content h3, .tl-detail-content h4 { font-size: 13px; color: var(--text-primary); margin: 8px 0 3px; }
.tl-detail-content p { margin-bottom: 6px; }
.tl-detail-content code { background: var(--bg-tertiary); padding: 1px 4px; border-radius: 3px; font-size: 12px; }
.tl-detail-content pre { background: var(--bg-tertiary); padding: 10px; border-radius: 6px; overflow-x: auto; margin: 8px 0; font-size: 12px; }
.tl-detail-content ul, .tl-detail-content ol { padding-left: 20px; margin-bottom: 8px; }
.tl-placeholder {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 100%; text-align: center; color: var(--text-muted); font-size: 13px; line-height: 1.6;
}
.tl-placeholder .icon { font-size: 32px; margin-bottom: 12px; opacity: 0.5; }
@media (max-width: 900px) {
  .timeline-3panel { grid-template-columns: 1fr; grid-template-rows: 120px 1fr 200px; }
  .tl-left { border-right: none; border-bottom: 1px solid var(--border); }
  .tl-right { border-left: none; border-top: 1px solid var(--border); }
}

/* Search tab */
.search-layout {
  flex-direction: column;
  width: 100%;
  height: 100%;
  overflow: hidden;
}
.search-bar {
  padding: 20px 32px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-secondary);
}
.search-input-wrap {
  position: relative;
  max-width: 640px;
}
.search-input {
  width: 100%;
  padding: 10px 16px 10px 38px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  color: var(--text-primary);
  outline: none;
  transition: border-color 0.15s;
}
.search-input:focus { border-color: var(--accent-blue); }
.search-input::placeholder { color: var(--text-muted); }
.search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 14px;
  pointer-events: none;
}
.search-meta {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 8px;
}
.search-results {
  flex: 1;
  overflow-y: auto;
  padding: 16px 32px;
}
.search-result {
  padding: 14px 18px;
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.15s;
  background: var(--bg-secondary);
}
.search-result:hover { border-color: var(--border-light); background: var(--bg-tertiary); }
.search-result-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}
.search-result-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
.search-result-path { font-size: 11px; color: var(--text-muted); }
.search-result-snippet {
  font-size: 12.5px;
  line-height: 1.6;
  color: var(--text-secondary);
  max-height: 60px;
  overflow: hidden;
}
.search-result-snippet mark {
  background: rgba(245,158,11,0.25);
  color: var(--accent-amber);
  border-radius: 2px;
  padding: 0 1px;
}

/* Analytics tab */
.analytics-layout {
  flex-direction: column;
  width: 100%;
  height: 100%;
  overflow-y: auto;
  padding: 28px 36px;
}
.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 28px;
}
.analytics-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
}
.analytics-card-title {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  color: var(--text-muted);
  margin-bottom: 14px;
}
.analytics-big-num {
  font-size: 36px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  line-height: 1;
  margin-bottom: 4px;
}
.analytics-big-label { font-size: 13px; color: var(--text-muted); }
.bar-chart { display: flex; flex-direction: column; gap: 8px; }
.bar-row { display: flex; align-items: center; gap: 10px; }
.bar-label {
  font-size: 12px;
  color: var(--text-secondary);
  width: 120px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-shrink: 0;
}
.bar-track {
  flex: 1;
  height: 20px;
  background: var(--bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}
.bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.4s ease;
  min-width: 2px;
}
.bar-value {
  font-size: 11px;
  color: var(--text-muted);
  width: 36px;
  text-align: right;
  flex-shrink: 0;
  font-variant-numeric: tabular-nums;
}
.analytics-section-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 16px;
}
.analytics-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}
.analytics-table th {
  text-align: left;
  padding: 10px 14px;
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  background: var(--bg-tertiary);
  border-bottom: 1px solid var(--border);
}
.analytics-table td {
  padding: 9px 14px;
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border);
}
.analytics-table tr:last-child td { border-bottom: none; }
.analytics-table tr:hover td { background: var(--bg-hover); }

/* Sync tab */
.sync-layout {
  flex-direction: column;
  width: 100%;
  height: 100%;
  overflow-y: auto;
  padding: 28px 36px;
}
.sync-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  max-width: 600px;
}
.sync-card-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 16px;
}
.sync-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.sync-row:last-child { border-bottom: none; }
.sync-label { color: var(--text-muted); }
.sync-value { color: var(--text-primary); font-weight: 500; }
.sync-status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 6px;
}
.sync-status-dot.green { background: var(--accent-green); box-shadow: 0 0 6px rgba(34,197,94,0.4); }
.sync-status-dot.amber { background: var(--accent-amber); box-shadow: 0 0 6px rgba(245,158,11,0.4); }

/* Loading / empty */
.loading-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  gap: 16px;
}
.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--accent-blue);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: var(--text-muted); font-size: 13px; }
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-muted);
  font-size: 14px;
  gap: 8px;
}
</style>
</head>
<body>

<div id="loading" class="loading-screen">
  <div class="spinner"></div>
  <div class="loading-text">Loading Engram data...</div>
</div>

<div id="app" class="app" style="display:none;">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">engram <span class="logo-sub">viewer</span></div>
    </div>
    <div class="header-stats" id="header-stats"></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="skills">Skills</div>
    <div class="tab" data-tab="timeline">Timeline</div>
    <div class="tab" data-tab="search">Search</div>
    <div class="tab" data-tab="analytics">Analytics</div>
    <div class="tab" data-tab="sync">Sync</div>
  </div>

  <!-- Skills -->
  <div class="tab-content active" data-panel="skills">
    <div class="skills-layout">
      <div class="sidebar">
        <div class="sidebar-header">Explorer</div>
        <div class="sidebar-tree" id="sidebar-tree"></div>
      </div>
      <div class="content-panel" id="content-panel">
        <div class="content-empty">
          <div class="content-empty-icon">&#128218;</div>
          <div class="content-empty-text">Select a skill or memory from the sidebar</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Timeline -->
  <div class="tab-content" data-panel="timeline">
    <div class="timeline-3panel">
      <!-- Left: Org tree -->
      <div class="tl-left">
        <h4>Organizations</h4>
        <div id="tl-org-tree"></div>
      </div>
      <!-- Center: 3D graph -->
      <div class="tl-graph">
        <div id="timeline-graph" style="width:100%;height:100%;"></div>
        <div class="tl-controls">
          <button class="timeline-btn active" id="btn-rotate" onclick="toggleRotate()">Auto-rotate</button>
          <button class="timeline-btn" id="btn-particles" onclick="toggleParticles()">Particles</button>
          <button class="timeline-btn" onclick="resetCamera()">Reset view</button>
        </div>
        <div class="tl-legend">&#9679; Memory &nbsp; &#9670; Skill &nbsp; # = chronological order</div>
      </div>
      <!-- Right: Detail panel -->
      <div class="tl-right" id="tl-right-panel">
        <div class="tl-placeholder">
          <div class="icon">&#128065;</div>
          <div>Click a node to see details</div>
          <div>Hover to preview</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div class="tab-content" data-panel="search">
    <div class="search-layout">
      <div class="search-bar">
        <div class="search-input-wrap">
          <span class="search-icon">&#128269;</span>
          <input class="search-input" id="search-input" type="text" placeholder="Search skills and memories..." autocomplete="off">
        </div>
        <div class="search-meta" id="search-meta"></div>
      </div>
      <div class="search-results" id="search-results">
        <div class="empty-state">Type to search across all skills and memories</div>
      </div>
    </div>
  </div>

  <!-- Analytics -->
  <div class="tab-content" data-panel="analytics">
    <div class="analytics-layout" id="analytics-panel"></div>
  </div>

  <!-- Sync -->
  <div class="tab-content" data-panel="sync">
    <div class="sync-layout" id="sync-panel"></div>
  </div>
</div>

<script>
// ============================================================
// Global State
// ============================================================
let DATA = null;
let allItems = [];
let orgColors = {};
let forceGraph = null;
let autoRotate = true;
let particlesEnabled = true;

const ORG_PALETTE = [
  '#3b82f6', '#8b5cf6', '#22c55e', '#f59e0b', '#f43f5e',
  '#06b6d4', '#6366f1', '#14b8a6', '#ec4899', '#84cc16',
  '#f97316', '#a855f7', '#0ea5e9', '#10b981'
];

// ============================================================
// Data Loading
// ============================================================
async function loadData() {
  try {
    const resp = await fetch('/api/data');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    DATA = await resp.json();
    processData();
    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    renderAll();
  } catch (err) {
    document.getElementById('loading').innerHTML = `
      <div style="color:var(--accent-rose);font-size:14px;">Failed to load data</div>
      <div style="color:var(--text-muted);font-size:12px;">${err.message}</div>
      <div style="color:var(--text-muted);font-size:12px;margin-top:8px;">
        Make sure the Engram server is running: <code>engram serve</code>
      </div>
    `;
  }
}

function processData() {
  allItems = [];
  const orgs = new Set();

  // Process skills
  const skills = DATA.skills || [];
  skills.forEach(s => {
    const fm = parseFrontmatter(s.content);
    allItems.push({
      type: 'skill',
      org: s.org || 'unknown',
      repo: s.repo || 'unknown',
      path: s.path || s.name,
      name: s.name,
      content: s.content,
      body: fm.body,
      frontmatter: fm.meta,
      tier: s.tier || 2,
      date: fm.meta.last_updated || fm.meta.date || null,
      wordCount: fm.body.split(/\s+/).filter(Boolean).length,
    });
    orgs.add(s.org || 'unknown');
  });

  // Process memories
  const memories = DATA.memories || [];
  memories.forEach(m => {
    const fm = parseFrontmatter(m.content);
    allItems.push({
      type: 'memory',
      org: m.org || 'unknown',
      repo: m.repo || '.memory',
      path: m.path || m.name,
      name: m.name,
      content: m.content,
      body: fm.body,
      frontmatter: fm.meta,
      tier: 0,
      date: fm.meta.date || null,
      wordCount: fm.body.split(/\s+/).filter(Boolean).length,
    });
    orgs.add(m.org || 'unknown');
  });

  // Assign org colors
  const orgList = Array.from(orgs).sort();
  orgList.forEach((org, i) => {
    orgColors[org] = ORG_PALETTE[i % ORG_PALETTE.length];
  });
}

function parseFrontmatter(content) {
  if (!content) return { meta: {}, body: '' };
  const trimmed = content.trim();
  if (!trimmed.startsWith('---')) return { meta: {}, body: trimmed };

  const endIndex = trimmed.indexOf('---', 3);
  if (endIndex === -1) return { meta: {}, body: trimmed };

  const fmBlock = trimmed.substring(3, endIndex).trim();
  const body = trimmed.substring(endIndex + 3).trim();
  const meta = {};

  fmBlock.split('\n').forEach(line => {
    const colonIdx = line.indexOf(':');
    if (colonIdx > 0) {
      const key = line.substring(0, colonIdx).trim();
      let val = line.substring(colonIdx + 1).trim();
      // Strip quotes
      if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) {
        val = val.slice(1, -1);
      }
      meta[key] = val;
    }
  });

  return { meta, body };
}

// ============================================================
// Rendering
// ============================================================
function renderAll() {
  renderHeaderStats();
  renderSidebar();
  renderAnalytics();
  renderSync();
}

function renderHeaderStats() {
  const skills = allItems.filter(i => i.type === 'skill').length;
  const memories = allItems.filter(i => i.type === 'memory').length;
  const orgs = new Set(allItems.map(i => i.org)).size;
  const words = allItems.reduce((sum, i) => sum + i.wordCount, 0);

  document.getElementById('header-stats').innerHTML = `
    <div class="stat"><strong>${skills}</strong> skills</div>
    <div class="stat"><strong>${memories}</strong> memories</div>
    <div class="stat"><strong>${orgs}</strong> orgs</div>
    <div class="stat"><strong>${words.toLocaleString()}</strong> words</div>
  `;
}

// ============================================================
// Sidebar Tree
// ============================================================
function renderSidebar() {
  const tree = {};
  allItems.forEach(item => {
    if (!tree[item.org]) tree[item.org] = {};
    const repoKey = item.type === 'memory' ? '.memory' : item.repo;
    if (!tree[item.org][repoKey]) tree[item.org][repoKey] = [];
    tree[item.org][repoKey].push(item);
  });

  let html = '';
  const sortedOrgs = Object.keys(tree).sort();

  sortedOrgs.forEach(org => {
    const color = orgColors[org] || '#71717a';
    html += `<div class="tree-org">`;
    html += `<div class="tree-org-header" onclick="toggleTree(this)">
      <span class="chevron">&#9660;</span>
      <span class="dot" style="background:${color};"></span>
      <span>${escapeHtml(org)}</span>
    </div>`;
    html += `<div class="tree-org-children">`;

    const sortedRepos = Object.keys(tree[org]).sort();
    sortedRepos.forEach(repo => {
      html += `<div class="tree-repo-header" onclick="toggleTree(this)">
        <span class="chevron">&#9660;</span>
        <span>${escapeHtml(repo)}</span>
      </div>`;
      html += `<div class="tree-repo-children">`;

      const items = tree[org][repo];
      items.sort((a, b) => (a.path || '').localeCompare(b.path || ''));

      items.forEach((item, idx) => {
        const icon = item.type === 'skill' ? '&#9733;' : '&#9679;';
        const iconColor = item.type === 'skill' ? 'var(--accent-blue)' : 'var(--accent-purple)';
        const globalIdx = allItems.indexOf(item);
        const displayName = item.path || item.name;
        html += `<div class="tree-item" data-index="${globalIdx}" onclick="selectItem(${globalIdx}, this)">
          <span class="icon" style="color:${iconColor};">${icon}</span>
          <span class="label" title="${escapeHtml(displayName)}">${escapeHtml(displayName)}</span>
        </div>`;
      });

      html += `</div>`;
    });

    html += `</div></div>`;
  });

  document.getElementById('sidebar-tree').innerHTML = html;
}

function toggleTree(el) {
  el.classList.toggle('collapsed');
}

function selectItem(index, el) {
  // Highlight
  document.querySelectorAll('.tree-item.active').forEach(e => e.classList.remove('active'));
  if (el) el.classList.add('active');

  const item = allItems[index];
  if (!item) return;

  renderContent(item);
}

function renderContent(item) {
  const panel = document.getElementById('content-panel');
  const color = orgColors[item.org] || '#71717a';
  const badgeClass = item.type === 'skill' ? 'badge-skill' : 'badge-memory';
  const badgeLabel = item.type === 'skill' ? 'Skill' : 'Memory';

  let fmHtml = '';
  const fm = item.frontmatter;
  if (fm && Object.keys(fm).length > 0) {
    fmHtml = '<div class="frontmatter-table">';
    Object.entries(fm).forEach(([k, v]) => {
      fmHtml += `<div class="fm-item"><span class="fm-key">${escapeHtml(k)}:</span><span class="fm-val">${escapeHtml(String(v))}</span></div>`;
    });
    fmHtml += '</div>';
  }

  // Render markdown
  let renderedBody = '';
  try {
    renderedBody = marked.parse(item.body || '');
  } catch (e) {
    renderedBody = `<pre>${escapeHtml(item.body || '')}</pre>`;
  }

  panel.innerHTML = `
    <div class="content-breadcrumb">
      <span style="color:${color};font-weight:600;">${escapeHtml(item.org)}</span>
      <span>/</span>
      <span>${escapeHtml(item.repo)}</span>
      <span>/</span>
      <span>${escapeHtml(item.path || item.name)}</span>
      <span class="content-type-badge ${badgeClass}">${badgeLabel}</span>
    </div>
    ${fmHtml}
    <div class="md-content">${renderedBody}</div>
  `;
  panel.scrollTop = 0;
}

// ============================================================
// Timeline (3D Force Graph)
// ============================================================
function initTimeline() {
  const container = document.getElementById('timeline-graph');
  if (!container || container.offsetWidth === 0) return;

  // Sort items chronologically: memories first (by date), then skills
  const sorted = [...allItems].sort((a, b) => {
    if (a.date && b.date) return a.date.localeCompare(b.date);
    if (a.date) return -1;
    if (b.date) return 1;
    return a.type === 'memory' ? -1 : 1;
  });

  // Build nodes and links
  const nodes = [];
  const links = [];
  const orgNodes = {};

  sorted.forEach((item, idx) => {
    const nodeId = `item-${idx}`;
    const color = orgColors[item.org] || '#71717a';
    nodes.push({
      id: nodeId,
      label: item.name || item.path,
      org: item.org,
      repo: item.repo,
      type: item.type,
      date: item.date,
      color: color,
      chronoNum: idx + 1,
      itemIndex: allItems.indexOf(item),
      val: item.type === 'skill' ? 3 : 2,
    });

    // Link sequential items from same org
    if (orgNodes[item.org]) {
      links.push({
        source: orgNodes[item.org],
        target: nodeId,
        color: color,
      });
    }
    orgNodes[item.org] = nodeId;
  });

  // Cross-org links for same-repo items
  const repoMap = {};
  nodes.forEach(n => {
    const key = `${n.org}/${n.repo}`;
    if (repoMap[key]) {
      links.push({
        source: repoMap[key],
        target: n.id,
        color: 'rgba(255,255,255,0.08)',
      });
    }
    repoMap[key] = n.id;
  });

  // Create number label textures
  function createNumberSprite(num, color) {
    const canvas = document.createElement('canvas');
    const size = 64;
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext('2d');

    // Glow
    ctx.shadowColor = 'rgba(255,255,255,0.6)';
    ctx.shadowBlur = 4;

    // Text
    ctx.fillStyle = 'rgba(255,255,255,0.85)';
    ctx.font = 'bold 28px -apple-system, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(String(num), size / 2, size / 2);

    const texture = new THREE.CanvasTexture(canvas);
    texture.needsUpdate = true;
    const spriteMat = new THREE.SpriteMaterial({
      map: texture,
      transparent: true,
      opacity: 0.7,
      depthWrite: false,
    });
    const sprite = new THREE.Sprite(spriteMat);
    sprite.scale.set(4, 4, 1);
    return sprite;
  }

  // Build graph
  const graphData = { nodes, links };

  forceGraph = ForceGraph3D()(container)
    .graphData(graphData)
    .backgroundColor('#09090b')
    .nodeThreeObject(node => {
      const group = new THREE.Group();
      const color = new THREE.Color(node.color);

      if (node.type === 'memory') {
        // Sphere for memories
        const geo = new THREE.SphereGeometry(3, 16, 16);
        const mat = new THREE.MeshLambertMaterial({
          color: color,
          emissive: color,
          emissiveIntensity: 0.3,
          transparent: true,
          opacity: 0.9,
        });
        group.add(new THREE.Mesh(geo, mat));
      } else {
        // Octahedron for skills
        const geo = new THREE.OctahedronGeometry(3.5);
        const mat = new THREE.MeshLambertMaterial({
          color: color,
          emissive: color,
          emissiveIntensity: 0.4,
          transparent: true,
          opacity: 0.9,
        });
        group.add(new THREE.Mesh(geo, mat));
      }

      // Number label sprite (superscript offset)
      const sprite = createNumberSprite(node.chronoNum, node.color);
      sprite.position.set(4, 5, 0);
      group.add(sprite);

      return group;
    })
    .linkWidth(0.4)
    .linkOpacity(0.25)
    .linkDirectionalParticles(particlesEnabled ? 2 : 0)
    .linkDirectionalParticleWidth(1.2)
    .linkDirectionalParticleSpeed(0.004)
    .linkDirectionalParticleColor(link => link.color || 'rgba(255,255,255,0.3)')
    .linkColor(link => link.color || 'rgba(255,255,255,0.1)')
    .onNodeHover(node => {
      container.style.cursor = node ? 'pointer' : 'default';
      if (node) {
        showTimelineDetail(node, true);
      }
    })
    .onNodeClick(node => {
      if (node && node.itemIndex !== undefined) {
        showTimelineDetail(node, false);
        // Highlight in org tree
        document.querySelectorAll('.tl-session-item.active').forEach(e => e.classList.remove('active'));
        const el = document.querySelector(`.tl-session-item[data-index="${node.itemIndex}"]`);
        if (el) {
          el.classList.add('active');
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    })
    .warmupTicks(60)
    .cooldownTicks(120);

  // Add lights
  const scene = forceGraph.scene();
  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
  dirLight.position.set(50, 50, 50);
  scene.add(dirLight);

  // Auto-rotate
  if (autoRotate) {
    const controls = forceGraph.controls();
    if (controls) {
      controls.autoRotate = true;
      controls.autoRotateSpeed = 0.5;
    }
  }

  // Fit camera after stabilization
  setTimeout(() => {
    forceGraph.zoomToFit(800, 80);
  }, 2000);
}

function toggleRotate() {
  autoRotate = !autoRotate;
  const btn = document.getElementById('btn-rotate');
  btn.classList.toggle('active', autoRotate);
  if (forceGraph) {
    const controls = forceGraph.controls();
    if (controls) controls.autoRotate = autoRotate;
  }
}

function toggleParticles() {
  particlesEnabled = !particlesEnabled;
  const btn = document.getElementById('btn-particles');
  btn.classList.toggle('active', particlesEnabled);
  if (forceGraph) {
    forceGraph.linkDirectionalParticles(particlesEnabled ? 2 : 0);
  }
}

function resetCamera() {
  if (forceGraph) {
    forceGraph.zoomToFit(600, 80);
  }
}

function buildTimelineOrgTree() {
  const tree = document.getElementById('tl-org-tree');
  if (!tree) return;

  // Group items by org, then by type
  const orgMap = {};
  allItems.forEach((item, idx) => {
    if (!orgMap[item.org]) orgMap[item.org] = [];
    orgMap[item.org].push({ item, index: idx });
  });

  let html = '';
  Object.keys(orgMap).sort().forEach(org => {
    const color = orgColors[org] || '#71717a';
    const items = orgMap[org];
    html += `<div class="tl-org-item" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">
      <div class="tl-org-dot" style="background:${color};"></div>
      <span>${escapeHtml(org)}</span>
      <span style="margin-left:auto;font-size:10px;color:var(--text-muted);">${items.length}</span>
    </div>`;
    html += `<div style="display:block;">`;
    items.forEach(({ item, index }) => {
      const label = item.name || item.path;
      const icon = item.type === 'skill' ? '&#9670;' : '&#9679;';
      html += `<div class="tl-session-item" data-index="${index}" onclick="timelineTreeClick(${index})">${icon} ${escapeHtml(label)}</div>`;
    });
    html += `</div>`;
  });

  tree.innerHTML = html;
}

function timelineTreeClick(index) {
  const item = allItems[index];
  if (!item) return;

  // Show detail in right panel
  showTimelineDetail({
    label: item.name || item.path,
    org: item.org,
    repo: item.repo,
    type: item.type,
    date: item.date,
    itemIndex: index,
    chronoNum: index + 1,
  }, false);

  // Highlight in tree
  document.querySelectorAll('.tl-session-item.active').forEach(e => e.classList.remove('active'));
  const el = document.querySelector(`.tl-session-item[data-index="${index}"]`);
  if (el) el.classList.add('active');
}

function showTimelineDetail(node, isHover) {
  const panel = document.getElementById('tl-right-panel');
  if (!panel) return;

  const item = allItems[node.itemIndex];
  if (!item) return;

  const color = orgColors[item.org] || '#71717a';
  const badgeClass = item.type === 'skill' ? 'badge-skill' : 'badge-memory';
  const badgeLabel = item.type === 'skill' ? 'Skill' : 'Memory';

  // Parse frontmatter
  const fmEntries = Object.entries(item.frontmatter || {}).filter(([k]) => k !== 'content');
  let fmHtml = '';
  if (fmEntries.length > 0) {
    fmHtml = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px;">`;
    fmEntries.slice(0, 6).forEach(([k, v]) => {
      fmHtml += `<div class="tl-metric-card">
        <div class="label">${escapeHtml(String(k))}</div>
        <div class="value" style="font-size:12px;">${escapeHtml(String(v).substring(0, 40))}</div>
      </div>`;
    });
    fmHtml += `</div>`;
  }

  // Render markdown body (truncated for hover, full for click)
  let bodyText = item.body || '';
  if (isHover && bodyText.length > 500) {
    bodyText = bodyText.substring(0, 500) + '\n\n*... click node for full content*';
  }
  const renderedBody = (typeof marked !== 'undefined' && marked.parse)
    ? marked.parse(bodyText) : bodyText.replace(/\n/g, '<br>');

  panel.innerHTML = `
    <div style="margin-bottom:12px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <span style="color:${color};font-weight:600;">&#9679;</span>
        <h3 style="font-size:14px;margin:0;">#${node.chronoNum} ${escapeHtml(item.name || item.path)}</h3>
      </div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
        <span style="color:${color};">${escapeHtml(item.org)}</span> / ${escapeHtml(item.repo)} / ${escapeHtml(item.path)}
        <span class="content-type-badge ${badgeClass}" style="font-size:9px;margin-left:6px;">${badgeLabel}</span>
      </div>
      ${item.date ? `<div style="font-size:11px;color:var(--text-muted);">Date: ${item.date}</div>` : ''}
    </div>
    <div class="tl-metrics">
      <div class="tl-metric-card">
        <div class="label">Words</div>
        <div class="value">${item.wordCount.toLocaleString()}</div>
      </div>
      <div class="tl-metric-card">
        <div class="label">Type</div>
        <div class="value">${item.type}</div>
      </div>
    </div>
    ${fmHtml}
    <div class="tl-detail-content">${renderedBody}</div>
  `;
}

// ============================================================
// Search
// ============================================================
function initSearch() {
  const input = document.getElementById('search-input');
  let debounceTimer;
  input.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => doSearch(input.value), 150);
  });
}

function doSearch(query) {
  const container = document.getElementById('search-results');
  const meta = document.getElementById('search-meta');

  if (!query || query.length < 2) {
    container.innerHTML = '<div class="empty-state">Type at least 2 characters to search</div>';
    meta.textContent = '';
    return;
  }

  const lower = query.toLowerCase();
  const results = [];

  allItems.forEach((item, idx) => {
    const searchText = `${item.name} ${item.path} ${item.org} ${item.repo} ${item.body}`.toLowerCase();
    const pos = searchText.indexOf(lower);
    if (pos >= 0) {
      // Find snippet around match in body
      const bodyLower = item.body.toLowerCase();
      const bodyPos = bodyLower.indexOf(lower);
      let snippet = '';
      if (bodyPos >= 0) {
        const start = Math.max(0, bodyPos - 60);
        const end = Math.min(item.body.length, bodyPos + query.length + 100);
        snippet = (start > 0 ? '...' : '') + item.body.substring(start, end) + (end < item.body.length ? '...' : '');
      } else {
        snippet = item.body.substring(0, 160) + (item.body.length > 160 ? '...' : '');
      }
      results.push({ item, index: idx, snippet, bodyPos });
    }
  });

  meta.textContent = `${results.length} result${results.length !== 1 ? 's' : ''} for "${query}"`;

  if (results.length === 0) {
    container.innerHTML = '<div class="empty-state">No results found</div>';
    return;
  }

  // Highlight function
  function highlight(text, q) {
    if (!q) return escapeHtml(text);
    const escaped = escapeHtml(text);
    const qEsc = escapeHtml(q);
    const regex = new RegExp(`(${qEsc.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return escaped.replace(regex, '<mark>$1</mark>');
  }

  container.innerHTML = results.slice(0, 50).map(r => {
    const item = r.item;
    const badgeClass = item.type === 'skill' ? 'badge-skill' : 'badge-memory';
    const badgeLabel = item.type === 'skill' ? 'Skill' : 'Memory';
    const color = orgColors[item.org] || '#71717a';
    return `
      <div class="search-result" onclick="searchResultClick(${r.index})">
        <div class="search-result-header">
          <span class="search-result-name">${highlight(item.name || item.path, query)}</span>
          <span class="content-type-badge ${badgeClass}" style="font-size:9px;">${badgeLabel}</span>
        </div>
        <div class="search-result-path" style="margin-bottom:6px;">
          <span style="color:${color};">${escapeHtml(item.org)}</span> / ${escapeHtml(item.repo)} / ${escapeHtml(item.path)}
        </div>
        <div class="search-result-snippet">${highlight(r.snippet, query)}</div>
      </div>
    `;
  }).join('');
}

function searchResultClick(index) {
  switchTab('skills');
  selectItem(index, null);
  const el = document.querySelector(`.tree-item[data-index="${index}"]`);
  if (el) {
    document.querySelectorAll('.tree-item.active').forEach(e => e.classList.remove('active'));
    el.classList.add('active');
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

// ============================================================
// Analytics
// ============================================================
function renderAnalytics() {
  const panel = document.getElementById('analytics-panel');
  const skills = allItems.filter(i => i.type === 'skill');
  const memories = allItems.filter(i => i.type === 'memory');
  const totalWords = allItems.reduce((s, i) => s + i.wordCount, 0);
  const orgs = [...new Set(allItems.map(i => i.org))];

  // Counts by org
  const orgCounts = {};
  allItems.forEach(item => {
    if (!orgCounts[item.org]) orgCounts[item.org] = { skills: 0, memories: 0, words: 0 };
    if (item.type === 'skill') orgCounts[item.org].skills++;
    else orgCounts[item.org].memories++;
    orgCounts[item.org].words += item.wordCount;
  });

  // Model usage
  const modelMap = {};
  allItems.forEach(item => {
    const m = item.frontmatter.model || 'unknown';
    modelMap[m] = (modelMap[m] || 0) + 1;
  });

  // Max values for bars
  const maxOrgTotal = Math.max(1, ...Object.values(orgCounts).map(c => c.skills + c.memories));
  const maxOrgWords = Math.max(1, ...Object.values(orgCounts).map(c => c.words));
  const maxModel = Math.max(1, ...Object.values(modelMap));

  let html = '';

  // Summary cards
  html += `<div class="analytics-grid">
    <div class="analytics-card">
      <div class="analytics-card-title">Total Items</div>
      <div class="analytics-big-num" style="color:var(--accent-blue);">${allItems.length}</div>
      <div class="analytics-big-label">${skills.length} skills + ${memories.length} memories</div>
    </div>
    <div class="analytics-card">
      <div class="analytics-card-title">Total Words</div>
      <div class="analytics-big-num" style="color:var(--accent-green);">${totalWords.toLocaleString()}</div>
      <div class="analytics-big-label">avg ${allItems.length ? Math.round(totalWords / allItems.length).toLocaleString() : 0} per item</div>
    </div>
    <div class="analytics-card">
      <div class="analytics-card-title">Organizations</div>
      <div class="analytics-big-num" style="color:var(--accent-purple);">${orgs.length}</div>
      <div class="analytics-big-label">${Object.keys(orgCounts).map(o => o).join(', ') || 'none'}</div>
    </div>
  </div>`;

  // Items by org chart
  html += `<div class="analytics-card" style="margin-bottom:20px;">
    <div class="analytics-card-title">Items by Organization</div>
    <div class="bar-chart">`;
  Object.entries(orgCounts).sort((a, b) => (b[1].skills + b[1].memories) - (a[1].skills + a[1].memories)).forEach(([org, counts]) => {
    const total = counts.skills + counts.memories;
    const pct = (total / maxOrgTotal) * 100;
    const color = orgColors[org] || '#71717a';
    html += `<div class="bar-row">
      <div class="bar-label" title="${org}">${escapeHtml(org)}</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${pct}%;background:${color};"></div>
      </div>
      <div class="bar-value">${total}</div>
    </div>`;
  });
  html += `</div></div>`;

  // Word count by org
  html += `<div class="analytics-card" style="margin-bottom:20px;">
    <div class="analytics-card-title">Word Count by Organization</div>
    <div class="bar-chart">`;
  Object.entries(orgCounts).sort((a, b) => b[1].words - a[1].words).forEach(([org, counts]) => {
    const pct = (counts.words / maxOrgWords) * 100;
    const color = orgColors[org] || '#71717a';
    html += `<div class="bar-row">
      <div class="bar-label" title="${org}">${escapeHtml(org)}</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${pct}%;background:${color};opacity:0.7;"></div>
      </div>
      <div class="bar-value">${counts.words.toLocaleString()}</div>
    </div>`;
  });
  html += `</div></div>`;

  // Model usage
  if (Object.keys(modelMap).length > 0) {
    html += `<div class="analytics-card" style="margin-bottom:20px;">
      <div class="analytics-card-title">Model Usage</div>
      <div class="bar-chart">`;
    Object.entries(modelMap).sort((a, b) => b[1] - a[1]).forEach(([model, count]) => {
      const pct = (count / maxModel) * 100;
      html += `<div class="bar-row">
        <div class="bar-label" title="${escapeHtml(model)}">${escapeHtml(model)}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${pct}%;background:var(--accent-amber);"></div>
        </div>
        <div class="bar-value">${count}</div>
      </div>`;
    });
    html += `</div></div>`;
  }

  // Detailed table
  html += `<div class="analytics-section-title" style="margin-top:8px;">All Items</div>
    <table class="analytics-table">
      <thead><tr>
        <th>Type</th><th>Organization</th><th>Repository</th><th>Path</th><th>Words</th><th>Date</th>
      </tr></thead>
      <tbody>`;
  allItems.forEach(item => {
    const color = orgColors[item.org] || '#71717a';
    html += `<tr>
      <td><span class="content-type-badge ${item.type === 'skill' ? 'badge-skill' : 'badge-memory'}" style="font-size:9px;">${item.type}</span></td>
      <td style="color:${color};font-weight:500;">${escapeHtml(item.org)}</td>
      <td>${escapeHtml(item.repo)}</td>
      <td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(item.path)}">${escapeHtml(item.path)}</td>
      <td style="font-variant-numeric:tabular-nums;">${item.wordCount.toLocaleString()}</td>
      <td style="color:var(--text-muted);">${item.date || '-'}</td>
    </tr>`;
  });
  html += `</tbody></table>`;

  panel.innerHTML = html;
}

// ============================================================
// Sync
// ============================================================
function renderSync() {
  const panel = document.getElementById('sync-panel');
  const skills = allItems.filter(i => i.type === 'skill').length;
  const memories = allItems.filter(i => i.type === 'memory').length;
  const orgs = [...new Set(allItems.map(i => i.org))];
  const model = DATA.model_used || DATA.analysis?.model || 'local';
  const genTime = DATA.generation_time_seconds;

  const now = new Date();
  const timeStr = now.toLocaleString();

  panel.innerHTML = `
    <div class="sync-card">
      <div class="sync-card-title">
        <span class="sync-status-dot green"></span>
        Data Status
      </div>
      <div class="sync-row">
        <span class="sync-label">Skills loaded</span>
        <span class="sync-value">${skills}</span>
      </div>
      <div class="sync-row">
        <span class="sync-label">Memories loaded</span>
        <span class="sync-value">${memories}</span>
      </div>
      <div class="sync-row">
        <span class="sync-label">Organizations</span>
        <span class="sync-value">${orgs.join(', ') || 'none'}</span>
      </div>
      <div class="sync-row">
        <span class="sync-label">Model</span>
        <span class="sync-value">${escapeHtml(String(model))}</span>
      </div>
      ${genTime ? `<div class="sync-row">
        <span class="sync-label">Generation time</span>
        <span class="sync-value">${genTime}s</span>
      </div>` : ''}
      <div class="sync-row">
        <span class="sync-label">Loaded at</span>
        <span class="sync-value">${timeStr}</span>
      </div>
      <div class="sync-row">
        <span class="sync-label">Source</span>
        <span class="sync-value">/api/data</span>
      </div>
      ${DATA.errors && DATA.errors.length > 0 ? `
      <div class="sync-row" style="flex-direction:column;align-items:flex-start;gap:4px;">
        <span class="sync-label"><span class="sync-status-dot amber"></span>Errors (${DATA.errors.length})</span>
        <div style="font-size:12px;color:var(--accent-rose);line-height:1.5;">
          ${DATA.errors.map(e => escapeHtml(e)).join('<br>')}
        </div>
      </div>` : ''}
    </div>

    <div class="sync-card" style="margin-top:16px;">
      <div class="sync-card-title">Engram CLI</div>
      <div class="sync-row">
        <span class="sync-label">Viewer</span>
        <span class="sync-value">Local Browser</span>
      </div>
      <div class="sync-row">
        <span class="sync-label">Backend</span>
        <span class="sync-value">Python / engram serve</span>
      </div>
      <div class="sync-row">
        <span class="sync-label">Data endpoint</span>
        <span class="sync-value" style="font-family:monospace;font-size:12px;">/api/data</span>
      </div>
    </div>
  `;
}

// ============================================================
// Tab Navigation
// ============================================================
let timelineInitialized = false;

function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  document.querySelectorAll('.tab-content').forEach(p => p.classList.toggle('active', p.dataset.panel === name));

  if (name === 'timeline' && !timelineInitialized && allItems.length > 0) {
    timelineInitialized = true;
    buildTimelineOrgTree();
    // Defer to allow container to render
    requestAnimationFrame(() => {
      setTimeout(initTimeline, 100);
    });
  }

  // Handle graph resize
  if (name === 'timeline' && forceGraph) {
    const container = document.getElementById('timeline-graph');
    forceGraph.width(container.offsetWidth);
    forceGraph.height(container.offsetHeight);
  }
}

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => switchTab(tab.dataset.tab));
});

// ============================================================
// Utilities
// ============================================================
function escapeHtml(str) {
  if (!str) return '';
  const el = document.createElement('span');
  el.textContent = str;
  return el.innerHTML;
}

// ============================================================
// Window resize
// ============================================================
window.addEventListener('resize', () => {
  if (forceGraph) {
    const container = document.getElementById('timeline-graph');
    if (container && container.offsetWidth > 0) {
      forceGraph.width(container.offsetWidth);
      forceGraph.height(container.offsetHeight);
    }
  }
});

// ============================================================
// Keyboard shortcuts
// ============================================================
document.addEventListener('keydown', (e) => {
  // Cmd/Ctrl+K for search
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    switchTab('search');
    setTimeout(() => document.getElementById('search-input').focus(), 50);
  }
  // Escape to reset timeline detail panel
  if (e.key === 'Escape') {
    const tlPanel = document.getElementById('tl-right-panel');
    if (tlPanel) {
      tlPanel.innerHTML = '<div class="tl-placeholder"><div class="icon">&#128065;</div><div>Click a node to see details</div><div>Hover to preview</div></div>';
    }
  }
  // Number keys for tabs
  if (!e.metaKey && !e.ctrlKey && !e.altKey && document.activeElement.tagName !== 'INPUT') {
    const tabMap = { '1': 'skills', '2': 'timeline', '3': 'search', '4': 'analytics', '5': 'sync' };
    if (tabMap[e.key]) {
      e.preventDefault();
      switchTab(tabMap[e.key]);
    }
  }
});

// ============================================================
// Init
// ============================================================
initSearch();
loadData();
</script>
</body>
</html>
